<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Configuration - GenHook</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        .main-layout {
            display: flex !important;
            gap: 1.5rem !important;
            width: 100% !important;
            align-items: flex-start !important;
        }
        
        .left-column {
            flex: 2 !important;
            min-width: 0 !important;
            max-width: 65% !important;
        }
        
        .right-column {
            flex: 1 !important;
            min-width: 450px !important;
            max-width: 35% !important;
            flex-shrink: 0 !important;
        }
        
        .payload-section {
            position: sticky !important;
            top: 20px !important;
            max-height: calc(100vh - 40px) !important;
            overflow-y: auto !important;
        }
        
        /* Force container to be full width and remove any Bootstrap interference */
        .container-fluid {
            max-width: 100% !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        
        @media (max-width: 1200px) {
            .left-column {
                max-width: 60% !important;
            }
            .right-column {
                max-width: 40% !important;
                min-width: 400px !important;
            }
        }
        
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column !important;
            }
            .left-column {
                max-width: 100% !important;
            }
            .right-column {
                max-width: 100% !important;
                min-width: auto !important;
            }
        }
        
        /* Tree Structure Styles */
        .field-tree {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        
        .tree-node {
            margin-bottom: 0.5rem;
        }
        
        .tree-node .btn-link {
            color: #6c757d;
            text-decoration: none;
            min-width: 20px;
            text-align: center;
        }
        
        .tree-node .btn-link:hover {
            color: #0d6efd;
        }
        
        .tree-children {
            border-left: 2px solid #dee2e6;
            margin-left: 10px;
            padding-left: 10px;
        }
        
        .tree-node .fas.fa-folder {
            color: #fd7e14 !important;
        }
        
        .tree-node .fas.fa-file {
            color: #198754 !important;
        }
        
        .form-check-label {
            cursor: pointer;
            user-select: none;
        }
        
        .form-check-label code {
            background-color: rgba(13, 110, 253, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/config">
                <i class="fas fa-webhook me-2"></i>GenHook Configuration
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/health" target="_blank">
                    <i class="fas fa-heart-pulse me-1"></i>Health
                </a>
                <a class="nav-link" href="/docs" target="_blank">
                    <i class="fas fa-book me-1"></i>API Docs
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-webhook text-primary me-2"></i>Webhook Configuration</h1>
            <div class="badge bg-success fs-6" id="configCount">{{ total_configs }} Configured</div>
        </div>

        <div class="main-layout">
            <!-- LEFT COLUMN: Current Configurations and Wizard -->
            <div class="left-column">
                <!-- Current Configurations Overview -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Current Configurations</h5>
                        <button class="btn btn-success btn-sm" onclick="showNewConfigWizard()" id="newConfigBtn">
                            <i class="fas fa-plus me-1"></i>New Config
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Token</th>
                                        <th>SL1 Alignment</th>
                                        <th>Template Preview</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="configurationsTable">
                                    <!-- Configurations will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Configuration Wizard (Hidden by default) -->
                <div class="card d-none" id="configWizard">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Create New Configuration</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="hideNewConfigWizard()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Step 1: Basic Information -->
                        <div id="step1" class="configuration-step">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Step 1: Basic Information</h6>
                            <div class="mb-3">
                                <label for="webhookType" class="form-label">Webhook Type Name</label>
                                <input type="text" class="form-control" id="webhookType" placeholder="e.g., github, stripe, slack">
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Security Token:</strong> A unique token will be generated when you save the configuration to secure your webhook endpoint.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quick Templates</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('github')">GitHub</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('stripe')">Stripe</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('slack')">Slack</button>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Use the Payload section on the right</strong> to load recent payloads or paste JSON data for analysis.
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-primary" onclick="analyzePayload()">
                                    <i class="fas fa-search me-1"></i>Analyze Payload
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Field Selection -->
                        <div id="step2" class="configuration-step d-none">
                            <h6 class="text-primary mb-3"><i class="fas fa-tasks me-2"></i>Step 2: Select Fields</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Available Fields</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="fieldsTree">
                                            <!-- Fields will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Selected Fields</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="selectedFields">
                                                <p class="text-muted"><i>No fields selected</i></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Template Preview (Edit Mode Only) -->
                            <div class="mt-3 d-none" id="currentTemplatePreview">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Current Message Template</h6>
                                    </div>
                                    <div class="card-body">
                                        <code id="currentTemplateText" class="text-dark"></code>
                                        <div class="mt-2">
                                            <small class="text-muted">Click "Edit Template" below to modify this message template</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" onclick="showStep(1)">
                                    <i class="fas fa-arrow-left me-1"></i>Back
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showStep(3)" disabled id="nextToTemplateBtn">
                                    <i class="fas fa-arrow-right me-1"></i><span id="nextToTemplateBtnText">Create Template</span>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Template Building -->
                        <div id="step3" class="configuration-step d-none">
                            <h6 class="text-primary mb-3"><i class="fas fa-edit me-2"></i>Step 3: Build Message Template</h6>
                            
                            <div class="mb-3">
                                <label for="messageTemplate" class="form-label">Message Template</label>
                                <textarea class="form-control" id="messageTemplate" rows="3" 
                                          placeholder="Create your message template using field variables..."></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Available Variables</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 200px; overflow-y: auto;" id="availableVariables">
                                            <!-- Variables will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Live Preview</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="messagePreview" class="border rounded p-2 bg-light">
                                                <em class="text-muted">Preview will appear here...</em>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" onclick="showStep(2)">
                                    <i class="fas fa-arrow-left me-1"></i>Back
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="testConfiguration()">
                                        <i class="fas fa-play me-1"></i>Test Config
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="saveConfiguration()" disabled id="saveConfigBtn">
                                        <i class="fas fa-save me-1"></i>Save Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Payload Section -->
            <div class="right-column">
                <div class="payload-section" style="position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-file-code me-2"></i>Webhook Payload</h6>
                        </div>
                        <div class="card-body">
                            <!-- Webhook Type Selection -->
                            <div class="mb-3">
                                <label class="form-label">Recent Payloads</label>
                                <select class="form-select mb-2" id="sidebarWebhookTypeSelect">
                                    <option value="">Select webhook type...</option>
                                </select>
                                <select class="form-select" id="sidebarRecentPayloadSelect" disabled>
                                    <option value="">Select a recent payload...</option>
                                </select>
                                <small class="form-text text-muted">Auto-loads when payload selected</small>
                            </div>
                            
                            <!-- JSON Payload Textarea -->
                            <div class="mb-3">
                                <label for="sidebarJsonPayload" class="form-label">JSON Payload</label>
                                <textarea class="form-control font-monospace" id="sidebarJsonPayload" rows="20" 
                                          placeholder="Select a recent payload above or paste your JSON webhook payload here..."></textarea>
                            </div>
                            
                            <!-- Payload Status -->
                            <div class="alert alert-info d-none" id="payloadStatus">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="payloadStatusText">No payload loaded</span>
                            </div>
                            
                            <!-- Payload Actions -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" onclick="validateSidebarJson()">
                                    <i class="fas fa-check-circle me-1"></i>Validate JSON
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="clearSidebarPayload()">
                                    <i class="fas fa-trash me-1"></i>Clear Payload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast for notifications -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
            <div id="notificationToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notification</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <!-- SL1 Alignment Modal -->
        <div class="modal fade" id="alignmentModal" tabindex="-1" aria-labelledby="alignmentModalLabel" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="alignmentModalLabel">Configure SL1 Alignment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-3">Select how this webhook should align to SL1 resources:</p>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="alignmentType" id="alignSystem" value="system" checked>
                            <label class="form-check-label" for="alignSystem">
                                <strong>System Default</strong>
                                <small class="text-muted d-block">Uses default SL1 configuration</small>
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="alignmentType" id="alignOrg" value="org">
                            <label class="form-check-label" for="alignOrg">
                                <strong>Organization ID</strong>
                                <small class="text-muted d-block">Align to specific organization</small>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="alignmentType" id="alignDevice" value="device">
                            <label class="form-check-label" for="alignDevice">
                                <strong>Device ID</strong>
                                <small class="text-muted d-block">Align to specific device</small>
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="alignmentId" class="form-label">ID Number</label>
                            <input type="number" class="form-control" id="alignmentId" placeholder="Enter ID (optional)" disabled>
                            <small class="form-text text-muted">Required when Organization or Device is selected</small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i>
                            This setting determines how the webhook aligns to resources in SL1 for event processing.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="confirmAlignment()">
                            <i class="fas fa-check me-1"></i>Confirm & Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webhook URL Modal -->
        <div class="modal fade" id="webhookUrlModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Configuration Saved!</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Your webhook is now ready!</strong> Copy the complete URL below to configure your webhook source.
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Complete Webhook URL:</strong></label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="modalWebhookUrl" readonly 
                                       style="font-size: 1rem; letter-spacing: 0.5px; padding: 12px;">
                                <button class="btn btn-success btn-lg" type="button" onclick="copyModalUrl()" id="copyModalBtn">
                                    <i class="fas fa-copy me-1"></i>Copy URL
                                </button>
                            </div>
                            <small class="form-text text-muted">This URL includes a unique security token - keep it secure</small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Ready to use:</strong> Save this URL securely and use it to configure your webhook source. You can also copy it later from the configuration table if needed.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            <i class="fas fa-check me-1"></i>Done
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SL1 Event Policy Modal -->
    <div class="modal fade" id="sl1PolicyModal" tabindex="-1" aria-labelledby="sl1PolicyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="sl1PolicyModalLabel">
                        <i class="fas fa-shield-alt me-2"></i>Create SL1 Event Policy
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        This will create an Event Policy in SL1 that matches webhooks from this service.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Service Name</label>
                            <input type="text" class="form-control" id="sl1PolicyService" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Token</label>
                            <input type="text" class="form-control font-monospace small" id="sl1PolicyToken" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sl1PolicySeverity" class="form-label">
                            <strong>Severity Level</strong> <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="sl1PolicySeverity" onchange="updateGraphQLPreview()">
                            <option value="">Select severity...</option>
                            <option value="4" class="text-danger">4 - Critical (Red)</option>
                            <option value="3" class="text-warning">3 - Major (Orange)</option>
                            <option value="2" class="text-info">2 - Minor (Yellow)</option>
                            <option value="1" class="text-primary">1 - Notice (Blue)</option>
                            <option value="0" class="text-success">0 - Healthy (Green)</option>
                        </select>
                        <small class="form-text text-muted">
                            Choose the severity level for alerts generated by this webhook
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">GraphQL Mutation Preview</label>
                        <textarea class="form-control font-monospace small" id="sl1PolicyGraphQL" rows="12" readonly 
                                  style="background-color: #f8f9fa;"></textarea>
                        <small class="form-text text-muted">
                            This is the exact GraphQL mutation that will be sent to SL1
                        </small>
                    </div>
                    
                    <div id="sl1PolicyResult" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="createSL1EventPolicy()" id="createPolicyBtn">
                        <i class="fas fa-shield-alt me-1"></i>Create Event Policy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-3 mt-5">
        <div class="container text-center text-muted">
            <small>GenHook v1.0 - Configuration-driven Webhook Processing</small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load app.js before inline scripts -->
    <script src="/static/js/app.js?v=3"></script>
    
    <script>
        // Global state
        let currentStep = 1;
        let analyzedPayload = null;
        let selectedFieldsList = [];
        let currentWebhookType = '';
        let currentToken = ''; // Track current token when editing
        let webConfig = {}; // Web interface configuration
        let isEditMode = false; // Track if we're editing an existing config

        // Load configurations and web config on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadWebConfig();
            loadConfigurations();
            
            // Initialize recent payload loading after app.js loads
            if (typeof initRecentPayloadLoading === 'function') {
                initRecentPayloadLoading();
            } else {
                // If app.js hasn't loaded yet, wait a bit and try again
                setTimeout(function() {
                    if (typeof initRecentPayloadLoading === 'function') {
                        initRecentPayloadLoading();
                    }
                }, 100);
            }
            
            // Initialize sidebar payload functionality
            initSidebarPayloadLoading();
            
            // Ensure payload status starts in correct state
            const payloadStatus = document.getElementById('payloadStatus');
            if (payloadStatus) {
                payloadStatus.classList.add('d-none'); // Hidden by default
            }
            
            // No auto-generation - tokens will be generated on save
        });

        async function loadWebConfig() {
            try {
                const response = await fetch('/api/web-config');
                if (response.ok) {
                    webConfig = await response.json();
                } else {
                    console.warn('Failed to load web config, using defaults');
                }
            } catch (error) {
                console.warn('Error loading web config:', error);
            }
        }

        function showNotification(title, message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            toastHeader.className = 'toast-header';
            if (type === 'success') {
                toastHeader.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastHeader.classList.add('bg-danger', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function showStep(step) {
            document.querySelectorAll('.configuration-step').forEach(s => s.classList.add('d-none'));
            document.getElementById(`step${step}`).classList.remove('d-none');
            currentStep = step;
            
            if (step === 3) {
                updateAvailableVariables();
                updatePreview();
            }
        }

        function validateJson() {
            const payload = document.getElementById('jsonPayload').value.trim();
            if (!payload) {
                showNotification('Error', 'Please enter a JSON payload', 'error');
                return false;
            }
            
            try {
                JSON.parse(payload);
                showNotification('Success', 'JSON is valid', 'success');
                document.getElementById('analyzeBtn').disabled = false;
                return true;
            } catch (e) {
                showNotification('Error', `Invalid JSON: ${e.message}`, 'error');
                return false;
            }
        }

        function loadSample(type) {
            const samples = {
                github: {
                    type: 'github',
                    payload: `{
  "action": "opened",
  "pull_request": {
    "title": "Add new feature",
    "user": {"login": "developer"}
  },
  "repository": {"name": "my-repo"}
}`
                },
                stripe: {
                    type: 'stripe', 
                    payload: `{
  "type": "payment_intent.succeeded",
  "data": {
    "object": {
      "amount": 2000,
      "currency": "usd",
      "status": "succeeded"
    }
  }
}`
                },
                slack: {
                    type: 'slack',
                    payload: `{
  "event": {
    "type": "message",
    "user": "U1234567",
    "text": "Hello world"
  }
}`
                }
            };
            
            const sample = samples[type];
            if (sample) {
                document.getElementById('webhookType').value = sample.type;
                document.getElementById('sidebarJsonPayload').value = sample.payload;
                validateSidebarJson();
            }
        }

        async function analyzePayload() {
            const webhookType = document.getElementById('webhookType').value.trim();
            const payload = document.getElementById('jsonPayload').value.trim();
            
            if (!webhookType || !validateJson()) return;
            
            try {
                const response = await fetch('/api/analyze-payload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        payload: JSON.parse(payload),
                        webhook_type: webhookType
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    analyzedPayload = result;
                    analyzedPayload.original_payload = JSON.parse(payload);
                    currentWebhookType = webhookType;
                    displayFields(result.fields);
                    showStep(2);
                    showNotification('Success', `Found ${result.total_fields} fields`, 'success');
                } else {
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to analyze payload', 'error');
            }
        }

        function displayFields(fields) {
            const container = document.getElementById('fieldsTree');
            container.innerHTML = '';
            
            // Add search bar and quick actions
            const searchBar = document.createElement('div');
            searchBar.className = 'mb-3';
            searchBar.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="fieldSearch" placeholder="Search fields..." onkeyup="filterFields()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="selectCommonFields()">
                                <i class="fas fa-magic me-1"></i>Smart Select
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSelections()">
                                <i class="fas fa-times me-1"></i>Clear All
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(searchBar);
            
            // Create tree container
            const treeContainer = document.createElement('div');
            treeContainer.className = 'field-tree';
            treeContainer.id = 'fieldTreeContainer';
            
            fields.forEach(field => {
                treeContainer.appendChild(createTreeNode(field, 0));
            });
            
            container.appendChild(treeContainer);
        }
        
        function createTreeNode(field, depth) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            nodeDiv.style.marginLeft = `${depth * 20}px`;
            
            if (field.is_leaf) {
                // Leaf node - selectable field
                nodeDiv.innerHTML = `
                    <div class="form-check d-flex align-items-center">
                        <input class="form-check-input me-2" type="checkbox" value="${field.pattern}" 
                               id="field_${field.path.replace(/\./g, '_')}" onchange="updateSelectedFields()">
                        <label class="form-check-label flex-grow-1" for="field_${field.path.replace(/\./g, '_')}">
                            <i class="fas fa-file text-success me-1"></i>
                            <code class="text-primary">${field.pattern}</code>
                            <small class="text-muted ms-2">(${field.field_type})</small>
                        </label>
                    </div>
                `;
            } else {
                // Container node - collapsible folder
                const folderId = `folder_${field.path.replace(/\./g, '_')}`;
                const childrenId = `children_${field.path.replace(/\./g, '_')}`;
                
                nodeDiv.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <button class="btn btn-sm btn-link p-0 me-2" onclick="toggleFolder('${childrenId}', this)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="form-check d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" 
                                   id="${folderId}" onchange="toggleFolderSelection('${folderId}', '${childrenId}')">
                            <label class="form-check-label" for="${folderId}">
                                <i class="fas fa-folder text-warning me-1"></i>
                                <strong>${field.path.split('.').pop()}</strong>
                                <small class="text-muted ms-2">(${field.field_count} fields)</small>
                            </label>
                        </div>
                    </div>
                    <div id="${childrenId}" class="tree-children" style="display: none;">
                    </div>
                `;
                
                // Add children
                const childrenContainer = nodeDiv.querySelector(`#${childrenId}`);
                if (field.children) {
                    field.children.forEach(child => {
                        childrenContainer.appendChild(createTreeNode(child, depth + 1));
                    });
                }
            }
            
            return nodeDiv;
        }
        
        function toggleFolder(childrenId, button) {
            const children = document.getElementById(childrenId);
            const icon = button.querySelector('i');
            
            if (children.style.display === 'none') {
                children.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            } else {
                children.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            }
        }
        
        function toggleFolderSelection(folderId, childrenId) {
            const folderCheckbox = document.getElementById(folderId);
            const childrenContainer = document.getElementById(childrenId);
            
            // Get all leaf checkboxes in this folder
            const leafCheckboxes = childrenContainer.querySelectorAll('input[type="checkbox"][value]');
            
            // Set all children to match parent state
            leafCheckboxes.forEach(checkbox => {
                checkbox.checked = folderCheckbox.checked;
            });
            
            // Update selected fields
            updateSelectedFields();
        }
        
        function filterFields() {
            const searchTerm = document.getElementById('fieldSearch').value.toLowerCase();
            const treeNodes = document.querySelectorAll('.tree-node');
            
            treeNodes.forEach(node => {
                const text = node.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    node.style.display = '';
                    // Expand parent folders if this node matches
                    expandParentFolders(node);
                } else {
                    node.style.display = 'none';
                }
            });
            
            // If search is empty, show all nodes and collapse folders
            if (!searchTerm) {
                treeNodes.forEach(node => node.style.display = '');
                collapseAllFolders();
            }
        }
        
        function expandParentFolders(node) {
            let parent = node.parentElement;
            while (parent && parent.id !== 'fieldTreeContainer') {
                if (parent.classList.contains('tree-children')) {
                    parent.style.display = 'block';
                    // Update chevron icon
                    const parentNode = parent.previousElementSibling;
                    const chevron = parentNode?.querySelector('.fa-chevron-right');
                    if (chevron) {
                        chevron.className = 'fas fa-chevron-down';
                    }
                }
                parent = parent.parentElement;
            }
        }
        
        function collapseAllFolders() {
            const childrenContainers = document.querySelectorAll('.tree-children');
            const chevrons = document.querySelectorAll('.fa-chevron-down');
            
            childrenContainers.forEach(container => {
                container.style.display = 'none';
            });
            
            chevrons.forEach(chevron => {
                chevron.className = 'fas fa-chevron-right';
            });
        }
        
        function selectCommonFields() {
            // Smart selection based on webhook type and common patterns
            const commonPatterns = [
                // GitHub patterns
                'ref', 'repository{name}', 'repository{full_name}', 'repository{owner{login}}',
                'pusher{name}', 'sender{login}', 'head_commit{message}', 'head_commit{author{name}}',
                'commits{message}', 'commits{author{name}}', 'action',
                
                // Stripe patterns  
                'type', 'data{object{amount}}', 'data{object{currency}}', 'data{object{status}}',
                'data{object{customer}}', 'data{object{id}}',
                
                // Slack patterns
                'event{type}', 'event{user}', 'event{text}', 'user{name}', 'channel{name}',
                
                // Common fields across services
                'id', 'name', 'type', 'status', 'created', 'updated', 'timestamp',
                'user', 'email', 'message', 'title', 'description'
            ];
            
            // Clear current selections
            clearAllSelections();
            
            // Select fields that match common patterns
            let selectedCount = 0;
            commonPatterns.forEach(pattern => {
                const checkbox = document.querySelector(`input[value="${pattern}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    selectedCount++;
                }
            });
            
            // If no exact matches, select some likely candidates based on field names
            if (selectedCount === 0) {
                const allCheckboxes = document.querySelectorAll('#fieldsTree input[value]');
                const likelyFields = [];
                
                allCheckboxes.forEach(checkbox => {
                    const value = checkbox.value.toLowerCase();
                    if (value.includes('name') || value.includes('id') || value.includes('type') || 
                        value.includes('status') || value.includes('message') || value.includes('title') ||
                        value.includes('user') || value.includes('email')) {
                        likelyFields.push(checkbox);
                    }
                });
                
                // Select up to 10 likely fields
                likelyFields.slice(0, 10).forEach(checkbox => {
                    checkbox.checked = true;
                    selectedCount++;
                });
            }
            
            updateSelectedFields();
            
            if (selectedCount > 0) {
                showNotification('Smart Select', `Selected ${selectedCount} common fields`, 'success');
            } else {
                showNotification('Smart Select', 'No common fields found - you can select fields manually', 'info');
            }
        }
        
        function clearAllSelections() {
            const allCheckboxes = document.querySelectorAll('#fieldsTree input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedFields();
        }

        function updateSelectedFields() {
            selectedFieldsList = [];
            // Only get leaf checkboxes (those with a value attribute)
            const checkboxes = document.querySelectorAll('#fieldsTree input[value]:checked');
            
            checkboxes.forEach(cb => selectedFieldsList.push(cb.value));
            
            const container = document.getElementById('selectedFields');
            if (selectedFieldsList.length === 0) {
                container.innerHTML = '<p class="text-muted"><i>No fields selected</i></p>';
            } else {
                container.innerHTML = selectedFieldsList.map(field => 
                    `<span class="badge bg-primary me-1 mb-1">${field}</span>`
                ).join('');
            }
            
            document.getElementById('nextToTemplateBtn').disabled = selectedFieldsList.length === 0;
        }

        function updateAvailableVariables() {
            const container = document.getElementById('availableVariables');
            if (selectedFieldsList.length === 0) {
                container.innerHTML = '<p class="text-muted"><i>No fields selected</i></p>';
                return;
            }
            
            const variables = selectedFieldsList.map(pattern => 
                pattern.replace(/\{([^}]+)\}/g, '.$1')
            );
            
            container.innerHTML = variables.map(variable => 
                `<div class="mb-1">
                    <code class="text-success cursor-pointer" onclick="insertVariable('${variable}')" 
                          style="cursor: pointer;">$${variable}$</code>
                </div>`
            ).join('');
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('messageTemplate');
            const pos = textarea.selectionStart;
            const text = textarea.value;
            textarea.value = text.substring(0, pos) + `$${variable}$` + text.substring(pos);
            textarea.focus();
            updatePreview();
        }

        function updatePreview() {
            const template = document.getElementById('messageTemplate').value;
            document.getElementById('messagePreview').textContent = template || 'Preview will appear here...';
            document.getElementById('saveConfigBtn').disabled = !template.trim();
        }

        function toggleEditTestPayload() {
            const payloadDiv = document.getElementById('editModeTestPayload');
            const toggleBtn = document.getElementById('toggleTestPayloadBtn');
            
            if (payloadDiv.classList.contains('d-none')) {
                payloadDiv.classList.remove('d-none');
                toggleBtn.innerHTML = '<i class="fas fa-times me-1"></i>Hide Test Payload';
            } else {
                payloadDiv.classList.add('d-none');
                toggleBtn.innerHTML = '<i class="fas fa-vial me-1"></i>Add Test Payload';
            }
        }

        async function testConfiguration() {
            const template = document.getElementById('messageTemplate').value.trim();
            if (!template) {
                showNotification('Error', 'Please enter a message template', 'error');
                return;
            }
            
            let testPayload = null;
            
            // First, check if user provided a manual test payload (edit mode)
            const editPayload = document.getElementById('editTestPayload').value.trim();
            if (editPayload) {
                try {
                    testPayload = JSON.parse(editPayload);
                } catch (e) {
                    showNotification('Error', 'Invalid JSON in test payload', 'error');
                    return;
                }
            } 
            // Otherwise, use the original analyzed payload (if it has real data)
            else if (analyzedPayload && analyzedPayload.original_payload && Object.keys(analyzedPayload.original_payload).length > 0) {
                testPayload = analyzedPayload.original_payload;
            } 
            // No payload available
            else {
                showNotification('Error', 'No test payload available. Please paste JSON in the test payload field.', 'error');
                return;
            }
            
            try {
                const requestData = {
                    webhook_type: currentWebhookType,
                    test_payload: testPayload,
                    selected_fields: selectedFieldsList,
                    message_template: template
                };
                
                const response = await fetch('/api/test-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                const previewDiv = document.getElementById('messagePreview');
                
                if (result.success) {
                    previewDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✅ Test Successful!</strong><br>
                            <strong>Generated Message:</strong><br>
                            <code>${result.generated_message}</code><br><br>
                            <strong>Processing Time:</strong> ${result.processing_time_ms}ms
                        </div>
                    `;
                    showNotification('Success', 'Configuration works!', 'success');
                } else {
                    previewDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>❌ Test Failed:</strong><br>
                            ${result.error_message || 'Unknown error'}
                        </div>
                    `;
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to test configuration', 'error');
            }
        }

        // Global variables for alignment settings
        let pendingAlignment = null;
        let currentAlignment = { type: 'system', id: null };
        
        // Handle alignment radio button changes
        document.addEventListener('DOMContentLoaded', function() {
            const alignmentRadios = document.querySelectorAll('input[name="alignmentType"]');
            const alignmentIdField = document.getElementById('alignmentId');
            
            alignmentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Enable/disable ID field based on selection
                    if (this.value === 'org' || this.value === 'device') {
                        alignmentIdField.disabled = false;
                        alignmentIdField.required = true;
                    } else {
                        alignmentIdField.disabled = true;
                        alignmentIdField.required = false;
                        alignmentIdField.value = '';
                    }
                });
            });
        });
        
        async function saveConfiguration() {
            const template = document.getElementById('messageTemplate').value.trim();
            
            if (!template) {
                showNotification('Error', 'Please enter a message template', 'error');
                return;
            }
            
            // Show alignment modal first
            const alignmentModal = new bootstrap.Modal(document.getElementById('alignmentModal'));
            alignmentModal.show();
            
            // Pre-populate alignment settings based on mode
            if (isEditMode && currentAlignment) {
                // In edit mode, use existing alignment values
                const alignmentType = currentAlignment.type;
                const alignmentId = currentAlignment.id;
                
                if (alignmentType === 'org') {
                    document.getElementById('alignOrg').checked = true;
                    document.getElementById('alignmentId').disabled = false;
                    document.getElementById('alignmentId').value = alignmentId || '';
                } else if (alignmentType === 'device') {
                    document.getElementById('alignDevice').checked = true;
                    document.getElementById('alignmentId').disabled = false;
                    document.getElementById('alignmentId').value = alignmentId || '';
                } else {
                    document.getElementById('alignSystem').checked = true;
                    document.getElementById('alignmentId').disabled = true;
                    document.getElementById('alignmentId').value = '';
                }
            } else {
                // New config mode, reset to defaults
                document.getElementById('alignSystem').checked = true;
                document.getElementById('alignmentId').value = '';
                document.getElementById('alignmentId').disabled = true;
            }
        }
        
        async function confirmAlignment() {
            // Get alignment settings
            const alignmentType = document.querySelector('input[name="alignmentType"]:checked').value;
            const alignmentId = document.getElementById('alignmentId').value;
            
            // Validate ID if needed
            if ((alignmentType === 'org' || alignmentType === 'device') && !alignmentId) {
                showNotification('Error', 'Please enter an ID number for the selected alignment type', 'error');
                return;
            }
            
            // Hide alignment modal
            const alignmentModal = bootstrap.Modal.getInstance(document.getElementById('alignmentModal'));
            alignmentModal.hide();
            
            // Continue with saving
            const template = document.getElementById('messageTemplate').value.trim();
            
            try {
                let token, isNewConfig;
                
                if (isEditMode) {
                    // In edit mode, use the existing token
                    token = currentToken;
                    isNewConfig = false;
                } else {
                    // New configuration - generate a token
                    const tokenResponse = await fetch('/api/generate-token');
                    const tokenResult = await tokenResponse.json();
                    
                    if (!tokenResult.success) {
                        showNotification('Error', 'Failed to generate security token', 'error');
                        return;
                    }
                    token = tokenResult.token;
                    isNewConfig = true;
                }
                
                const configLine = selectedFieldsList.join(',') + '::' + template;
                
                // Prepare alignment data
                let alignmentData = {};
                if (alignmentType !== 'system') {
                    alignmentData = {
                        alignment_type: alignmentType,
                        alignment_id: parseInt(alignmentId)
                    };
                }
                
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        webhook_type: currentWebhookType,
                        token: token,
                        config_line: configLine,
                        create_backup: true,
                        ...alignmentData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (isNewConfig) {
                        // Show success modal only for new configurations
                        showWebhookUrlModal(result.webhook_url);
                    } else {
                        // Edit mode - just show success notification
                        showNotification('Success', `Configuration updated successfully`, 'success');
                    }
                    
                    // Force complete reset and refresh
                    resetWizard();
                    loadConfigurations();
                    refreshSidebarData();
                } else {
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to save configuration', 'error');
            }
        }

        function resetWizard() {
            // Clear all global state
            analyzedPayload = null;
            selectedFieldsList = [];
            currentWebhookType = '';
            currentToken = '';
            isEditMode = false;
            currentAlignment = { type: 'system', id: null };
            
            // Clear all form fields
            document.getElementById('webhookType').value = '';
            document.getElementById('sidebarJsonPayload').value = '';
            document.getElementById('messageTemplate').value = '';
            
            // Clear sidebar selections
            const sidebarWebhookTypeSelect = document.getElementById('sidebarWebhookTypeSelect');
            const sidebarRecentPayloadSelect = document.getElementById('sidebarRecentPayloadSelect');
            if (sidebarWebhookTypeSelect) sidebarWebhookTypeSelect.value = '';
            if (sidebarRecentPayloadSelect) {
                sidebarRecentPayloadSelect.value = '';
                sidebarRecentPayloadSelect.disabled = true;
            }
            
            // Clear all dynamic content areas
            document.getElementById('fieldsTree').innerHTML = '';
            document.getElementById('selectedFields').innerHTML = '<p class="text-muted"><i>No fields selected</i></p>';
            document.getElementById('availableVariables').innerHTML = '';
            document.getElementById('messagePreview').innerHTML = '<em class="text-muted">Preview will appear here...</em>';
            
            // Hide template preview and reset button text
            const templatePreview = document.getElementById('currentTemplatePreview');
            const nextBtn = document.getElementById('nextToTemplateBtnText');
            if (templatePreview) templatePreview.classList.add('d-none');
            if (nextBtn) nextBtn.textContent = 'Create Template';
            
            // Reset all button states
            document.getElementById('nextToTemplateBtn').disabled = true;
            document.getElementById('saveConfigBtn').disabled = true;
            
            // Clear any selected checkboxes in fields tree
            const checkboxes = document.querySelectorAll('#fieldsTree input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // Reset to step 1
            showStep(1);
        }

        async function loadConfigurations() {
            try {
                const response = await fetch('/api/configs');
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.getElementById('configurationsTable');
                    tbody.innerHTML = '';
                    
                    Object.entries(result.configurations).forEach(([configKey, configLine]) => {
                        let fields, template, alignment = '';
                        
                        // Parse config line - support both old and new formats
                        if (configLine.includes('::')) {
                            // Old format: fields::message
                            [fields, template] = configLine.split('::', 2);
                        } else {
                            // New format: alignment|fields|message
                            const parts = configLine.split('|', 3);
                            if (parts.length === 3) {
                                [alignment, fields, template] = parts;
                            } else {
                                // Fallback
                                fields = parts[0] || '';
                                template = parts[1] || '';
                            }
                        }
                        
                        // Parse service and token from config key
                        let service, token;
                        if (configKey.includes('_')) {
                            const parts = configKey.split('_');
                            if (parts.length >= 2) {
                                // Last part is token, everything before is service
                                token = parts[parts.length - 1];
                                service = parts.slice(0, -1).join('_');
                            } else {
                                service = configKey;
                                token = 'legacy';
                            }
                        } else {
                            service = configKey;
                            token = 'legacy';
                        }
                        
                        // Format alignment display
                        let alignmentDisplay = 'System Default';
                        if (alignment) {
                            const [type, id] = alignment.split(':');
                            if (type === 'org') {
                                alignmentDisplay = `Organization ${id}`;
                            } else if (type === 'device') {
                                alignmentDisplay = `Device ${id}`;
                            }
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><code>${service}</code></td>
                            <td class="small">
                                <code class="text-muted">${token.length > 12 ? token.substring(0, 10) + '...' : token}</code>
                            </td>
                            <td class="small">
                                <span class="badge bg-info">${alignmentDisplay}</span>
                            </td>
                            <td class="small">${template.length > 60 ? template.substring(0, 60) + '...' : template}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="copyWebhookUrl('${service}', '${token}')" title="Copy Webhook URL">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToken('${token}')" title="Copy Token">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="showSL1PolicyModal('${service}', '${token}')" title="Create SL1 Event Policy">
                                    <i class="fas fa-shield-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editConfig('${service}', '${token}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${service}', '${token}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('configCount').textContent = `${result.total_count} Configured`;
                }
            } catch (error) {
                console.error('Failed to load configurations:', error);
            }
        }

        async function editConfig(service, token) {
            try {
                const response = await fetch(`/api/config/${service}/${token}`);
                const result = await response.json();
                
                if (response.ok) {
                    resetWizard();
                    
                    // Set edit mode and track current token
                    isEditMode = true;
                    currentWebhookType = service;
                    currentToken = token;
                    
                    // Store current alignment for edit mode
                    currentAlignment = {
                        type: result.alignment_type || 'system',
                        id: result.alignment_id || null
                    };
                    
                    document.getElementById('webhookType').value = service;
                    document.getElementById('messageTemplate').value = result.message_template;
                    selectedFieldsList = result.fields;
                    
                    const mockFields = result.fields.map(field => ({
                        pattern: field,
                        path: field.replace(/\{/g, '.').replace(/\}/g, ''),
                        field_type: 'string',
                        is_leaf: true,
                        children: null,
                        field_count: null
                    }));
                    
                    analyzedPayload = {
                        success: true,
                        fields: mockFields,
                        original_payload: {}
                    };
                    
                    displayFields(mockFields);
                    selectedFieldsList.forEach(field => {
                        const checkbox = document.querySelector(`input[value="${field}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    updateSelectedFields();
                    
                    // Enable the "Create Template" button since fields are already selected
                    document.getElementById('nextToTemplateBtn').disabled = false;
                    
                    // Show the configuration wizard (pass true to skip step change)
                    showNewConfigWizard(true);
                    
                    // Show step 2 AFTER showing the wizard
                    showStep(2);
                    
                    // Show current template preview in edit mode
                    const templatePreview = document.getElementById('currentTemplatePreview');
                    const templateText = document.getElementById('currentTemplateText');
                    const nextBtn = document.getElementById('nextToTemplateBtnText');
                    
                    if (templatePreview && templateText && result.message_template) {
                        templatePreview.classList.remove('d-none');
                        templateText.textContent = result.message_template;
                        nextBtn.textContent = 'Edit Template';
                    }
                    
                    // Auto-populate sidebar webhook type for easy payload loading
                    const sidebarWebhookTypeSelect = document.getElementById('sidebarWebhookTypeSelect');
                    if (sidebarWebhookTypeSelect) {
                        sidebarWebhookTypeSelect.value = service;
                        // Trigger change event to load recent payloads
                        const event = new Event('change');
                        sidebarWebhookTypeSelect.dispatchEvent(event);
                    }
                    
                    showNotification('Edit Mode', `Editing configuration for '${service}:${token}' - Use the sidebar to load recent payloads for testing`, 'info');
                } else {
                    showNotification('Error', 'Failed to load configuration', 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to load configuration', 'error');
            }
        }

        async function deleteConfig(service, token) {
            if (!confirm(`Delete configuration for '${service}:${token}'?`)) return;
            
            try {
                const response = await fetch(`/api/config/${service}/${token}`, {method: 'DELETE'});
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Success', `Webhook '${service}:${token}' deleted`, 'success');
                    loadConfigurations();
                    refreshSidebarData();
                } else {
                    showNotification('Error', result.detail || 'Delete failed', 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to delete configuration', 'error');
            }
        }
        
        // SL1 Event Policy functions
        let currentSL1Policy = { service: '', token: '' };
        
        function showSL1PolicyModal(service, token) {
            // Store current values
            currentSL1Policy.service = service;
            currentSL1Policy.token = token;
            
            // Populate modal fields
            document.getElementById('sl1PolicyService').value = service;
            document.getElementById('sl1PolicyToken').value = token;
            document.getElementById('sl1PolicySeverity').value = '';
            document.getElementById('sl1PolicyGraphQL').value = '';
            document.getElementById('sl1PolicyResult').style.display = 'none';
            
            // Reset button state
            document.getElementById('createPolicyBtn').disabled = false;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('sl1PolicyModal'));
            modal.show();
        }
        
        function updateGraphQLPreview() {
            const severity = document.getElementById('sl1PolicySeverity').value;
            
            if (!severity) {
                document.getElementById('sl1PolicyGraphQL').value = 'Please select a severity level first';
                return;
            }
            
            // Generate GraphQL preview
            const graphql = `mutation CreateEventPolicy {
  createEventPolicy(
    message: "%I"
    messageMatch: false
    identifierPattern: ".*\\\\|.*\\\\|(.*)"
    enabled: true
    identifierResultFormat: ""
    multiMatch: false
    name: "GENHOOK_${currentSL1Policy.service}"
    regularExpression1: "${currentSL1Policy.token}"
    regularExpression2: ""
    regularExpressionSearch: true
    severity: ${severity}
    source: 6
  ) {
    id
  }
}`;
            
            document.getElementById('sl1PolicyGraphQL').value = graphql;
        }
        
        async function createSL1EventPolicy() {
            const severity = document.getElementById('sl1PolicySeverity').value;
            
            if (!severity) {
                showNotification('Error', 'Please select a severity level', 'error');
                return;
            }
            
            // Validate severity value
            const severityInt = parseInt(severity);
            if (isNaN(severityInt) || severityInt < 0 || severityInt > 4) {
                showNotification('Error', `Invalid severity value: ${severity}. Must be 0-4.`, 'error');
                return;
            }
            
            // Disable button to prevent double-clicks
            const btn = document.getElementById('createPolicyBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Policy...';
            
            try {
                const response = await fetch('/api/sl1/create-event-policy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        service_name: currentSL1Policy.service,
                        token: currentSL1Policy.token,
                        severity: severityInt
                    })
                });
                
                const result = await response.json();
                
                // Show result in modal
                const resultDiv = document.getElementById('sl1PolicyResult');
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i>
                            <strong>Success!</strong> ${result.message || 'Event Policy created successfully'}
                            ${result.policy_id ? `<br>Policy ID: <code>${result.policy_id}</code>` : ''}
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Also show notification
                    showNotification('Success', `SL1 Event Policy created for ${currentSL1Policy.service}`, 'success');
                    
                    // Keep modal open to show success message
                    setTimeout(() => {
                        // Close modal after 3 seconds
                        bootstrap.Modal.getInstance(document.getElementById('sl1PolicyModal')).hide();
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            <strong>Error:</strong> ${result.error || 'Failed to create Event Policy'}
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Re-enable button for retry
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shield-alt me-1"></i>Create Event Policy';
                    
                    showNotification('Error', result.error || 'Failed to create SL1 Event Policy', 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to connect to SL1 GraphQL API', 'error');
                
                // Re-enable button for retry
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shield-alt me-1"></i>Create Event Policy';
                
                // Show error in modal
                const resultDiv = document.getElementById('sl1PolicyResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        <strong>Connection Error:</strong> ${error.message || 'Failed to connect to SL1 GraphQL API'}
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        }
        
        // New functions for modal and webhook URL handling
        function showWebhookUrlModal(webhookUrl) {
            document.getElementById('modalWebhookUrl').value = webhookUrl;
            
            const modal = new bootstrap.Modal(document.getElementById('webhookUrlModal'));
            modal.show();
        }
        
        function copyModalUrl() {
            const url = document.getElementById('modalWebhookUrl').value;
            copyToClipboard('', url);
            
            const btn = document.getElementById('copyModalBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-light');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-light');
                btn.classList.add('btn-success');
            }, 2000);
            
            showNotification('Success', 'Webhook URL copied to clipboard!', 'success');
        }
        
        function copyWebhookUrl(service, token) {
            const baseUrl = `${window.location.protocol}//${window.location.host}`;
            // Convert service to lowercase to match backend processing
            const webhookUrl = `${baseUrl}/webhook/${service.toLowerCase()}/${token}`;
            
            copyToClipboard('', webhookUrl);
            showNotification('Copied', 'Webhook URL copied to clipboard', 'success');
        }
        
        function copyToken(token) {
            copyToClipboard(null, token);
            showNotification('Copied', 'Token copied to clipboard', 'success');
        }
        
        function copyToClipboard(elementId, text = null) {
            const textToCopy = text || document.getElementById(elementId).value;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy);
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        // NEW UI FUNCTIONS FOR SIDEBAR PAYLOAD SECTION
        
        function showNewConfigWizard(skipStepChange = false) {
            const wizard = document.getElementById('configWizard');
            wizard.classList.remove('d-none');
            
            // Ensure payload status is visible
            const payloadStatus = document.getElementById('payloadStatus');
            if (payloadStatus) {
                payloadStatus.classList.remove('d-none');
                document.getElementById('payloadStatusText').textContent = 'Ready for payload input';
            }
            
            // Only show step 1 if not in edit mode
            if (!skipStepChange) {
                showStep(1);
            }
            
            // Scroll wizard into view with some delay to ensure DOM is updated
            setTimeout(() => {
                wizard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        function hideNewConfigWizard() {
            document.getElementById('configWizard').classList.add('d-none');
            document.getElementById('payloadStatus').classList.add('d-none');
            resetWizard();
        }
        
        function initSidebarPayloadLoading() {
            // Load available webhook types for sidebar
            loadSidebarWebhookTypes();
            
            // Handle sidebar webhook type selection
            const sidebarWebhookTypeSelect = document.getElementById('sidebarWebhookTypeSelect');
            if (sidebarWebhookTypeSelect) {
                sidebarWebhookTypeSelect.addEventListener('change', function() {
                    const webhookType = this.value;
                    if (webhookType) {
                        loadSidebarRecentPayloads(webhookType);
                    } else {
                        resetSidebarPayloadSelection();
                    }
                });
            }
            
            // Handle sidebar payload selection - auto-load when selected
            const sidebarRecentPayloadSelect = document.getElementById('sidebarRecentPayloadSelect');
            if (sidebarRecentPayloadSelect) {
                sidebarRecentPayloadSelect.addEventListener('change', function() {
                    if (this.value) {
                        loadSidebarPayload();
                    } else {
                        clearSidebarPayload();
                    }
                });
            }
        }
        
        async function loadSidebarWebhookTypes() {
            try {
                const response = await fetch('/api/webhook-logs/types');
                const data = await response.json();
                
                const select = document.getElementById('sidebarWebhookTypeSelect');
                if (select) {
                    // Clear existing options except the first one
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // Add webhook types
                    if (data.success && data.webhook_types) {
                        data.webhook_types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.warn('Could not load webhook types for sidebar:', error);
            }
        }
        
        function refreshSidebarData() {
            // Get current selected webhook type in sidebar before refreshing dropdown
            const sidebarWebhookTypeSelect = document.getElementById('sidebarWebhookTypeSelect');
            const currentSelectedType = sidebarWebhookTypeSelect ? sidebarWebhookTypeSelect.value : null;
            
            // Reload webhook types dropdown first
            loadSidebarWebhookTypes().then(() => {
                // After dropdown is reloaded, restore selection and reload recent payloads if applicable
                if (currentSelectedType && sidebarWebhookTypeSelect) {
                    // Try to restore previous selection (webhook type might still exist)
                    sidebarWebhookTypeSelect.value = currentSelectedType;
                    
                    // If selection was restored, reload recent payloads
                    if (sidebarWebhookTypeSelect.value === currentSelectedType) {
                        loadSidebarRecentPayloads(currentSelectedType);
                    }
                }
            });
        }

        async function loadSidebarRecentPayloads(webhookType) {
            try {
                const response = await fetch(`/api/webhook-logs/${webhookType}/recent?limit=10`);
                const data = await response.json();
                
                const select = document.getElementById('sidebarRecentPayloadSelect');
                
                if (select) {
                    // Clear existing options except the first one
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    if (data.success && data.payloads) {
                        data.payloads.forEach((entry, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            
                            // Create a readable timestamp
                            const timestamp = new Date(entry.timestamp).toLocaleString();
                            const status = entry.processing_status || 'logged';
                            
                            option.textContent = `${timestamp} (${status})`;
                            option.dataset.payload = JSON.stringify(entry.payload);
                            select.appendChild(option);
                        });
                        
                        select.disabled = false;
                    } else {
                        select.disabled = true;
                    }
                }
            } catch (error) {
                console.error('Error loading sidebar recent payloads:', error);
                showNotification('Error', 'Error loading recent payloads', 'error');
            }
        }
        
        function loadSidebarPayload() {
            const payloadSelect = document.getElementById('sidebarRecentPayloadSelect');
            const selectedOption = payloadSelect.selectedOptions[0];
            
            if (selectedOption && selectedOption.dataset.payload) {
                try {
                    const payload = JSON.parse(selectedOption.dataset.payload);
                    const textarea = document.getElementById('sidebarJsonPayload');
                    
                    if (textarea) {
                        textarea.value = JSON.stringify(payload, null, 2);
                        
                        // Update status
                        document.getElementById('payloadStatus').classList.remove('d-none');
                        document.getElementById('payloadStatusText').textContent = 'Recent payload loaded';
                        document.getElementById('payloadStatus').className = 'alert alert-success';
                        
                        showNotification('Success', 'Recent payload loaded to sidebar', 'success');
                    }
                } catch (error) {
                    console.error('Error loading sidebar payload:', error);
                    showNotification('Error', 'Error loading payload', 'error');
                }
            }
        }
        
        function resetSidebarPayloadSelection() {
            const payloadSelect = document.getElementById('sidebarRecentPayloadSelect');
            if (payloadSelect) {
                payloadSelect.disabled = true;
                payloadSelect.innerHTML = '<option value="">Select a recent payload...</option>';
            }
            clearSidebarPayload();
        }
        
        function clearSidebarPayload() {
            document.getElementById('sidebarJsonPayload').value = '';
            document.getElementById('payloadStatusText').textContent = 'Payload cleared';
            document.getElementById('payloadStatus').className = 'alert alert-info';
        }
        
        function validateSidebarJson() {
            const payload = document.getElementById('sidebarJsonPayload').value.trim();
            if (!payload) {
                document.getElementById('payloadStatusText').textContent = 'No payload to validate';
                document.getElementById('payloadStatus').className = 'alert alert-info';
                return false;
            }
            try {
                JSON.parse(payload);
                document.getElementById('payloadStatusText').textContent = 'Valid JSON payload';
                document.getElementById('payloadStatus').className = 'alert alert-success';
                document.getElementById('payloadStatus').classList.remove('d-none');
                return true;
            } catch (e) {
                document.getElementById('payloadStatusText').textContent = 'Invalid JSON: ' + e.message;
                document.getElementById('payloadStatus').className = 'alert alert-danger';
                document.getElementById('payloadStatus').classList.remove('d-none');
                return false;
            }
        }
        
        // Override the original analyzePayload function to use sidebar data
        async function analyzePayload() {
            const webhookType = document.getElementById('webhookType').value.trim();
            const sidebarPayload = document.getElementById('sidebarJsonPayload').value.trim();
            
            if (!webhookType) {
                showNotification('Error', 'Please enter a webhook type name', 'error');
                return;
            }
            
            if (!sidebarPayload) {
                showNotification('Error', 'Please load or paste a JSON payload in the sidebar', 'error');
                return;
            }
            
            if (!validateSidebarJson()) {
                return;
            }
            
            try {
                const response = await fetch('/api/analyze-payload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        payload: JSON.parse(sidebarPayload),
                        webhook_type: webhookType
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    analyzedPayload = result;
                    analyzedPayload.original_payload = JSON.parse(sidebarPayload);
                    currentWebhookType = webhookType;
                    displayFields(result.fields);
                    showStep(2);
                    showNotification('Success', `Found ${result.total_fields} fields`, 'success');
                } else {
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to analyze payload', 'error');
            }
        }
        
        // Override testConfiguration to use sidebar payload
        async function testConfiguration() {
            const template = document.getElementById('messageTemplate').value.trim();
            if (!template) {
                showNotification('Error', 'Please enter a message template', 'error');
                return;
            }
            
            const sidebarPayload = document.getElementById('sidebarJsonPayload').value.trim();
            if (!sidebarPayload || !validateSidebarJson()) {
                showNotification('Error', 'Please ensure a valid JSON payload is loaded in the sidebar', 'error');
                return;
            }
            
            try {
                const requestData = {
                    webhook_type: currentWebhookType,
                    test_payload: JSON.parse(sidebarPayload),
                    selected_fields: selectedFieldsList,
                    message_template: template
                };
                
                const response = await fetch('/api/test-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                const previewDiv = document.getElementById('messagePreview');
                
                if (result.success) {
                    previewDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✅ Test Successful!</strong><br>
                            <strong>Generated Message:</strong><br>
                            <code>${result.generated_message}</code><br><br>
                            <strong>Processing Time:</strong> ${result.processing_time_ms}ms
                        </div>
                    `;
                    showNotification('Success', 'Configuration works!', 'success');
                } else {
                    previewDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>❌ Test Failed:</strong><br>
                            ${result.error_message || 'Unknown error'}
                        </div>
                    `;
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to test configuration', 'error');
            }
        }

        // Auto-update preview
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageTemplate').addEventListener('input', updatePreview);
        });
    </script>
</body>
</html>