<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Configuration - GenHook</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/config">
                <i class="fas fa-webhook me-2"></i>GenHook Configuration
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/health" target="_blank">
                    <i class="fas fa-heart-pulse me-1"></i>Health
                </a>
                <a class="nav-link" href="/docs" target="_blank">
                    <i class="fas fa-book me-1"></i>API Docs
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-webhook text-primary me-2"></i>Webhook Configuration</h1>
                    <div class="badge bg-success fs-6" id="configCount">{{ total_configs }} Configured</div>
                </div>
            </div>
        </div>

        <!-- Current Configurations Overview -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Current Configurations</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Webhook Type</th>
                                        <th>Fields</th>
                                        <th>Template Preview</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="configurationsTable">
                                    {% for webhook_type, config_line in current_configs.items() %}
                                    {% set fields, template = config_line.split('::', 1) %}
                                    <tr>
                                        <td><code>{{ webhook_type }}</code></td>
                                        <td class="small text-muted">{{ fields[:50] + ('...' if fields|length > 50 else '') }}</td>
                                        <td class="small">{{ template[:60] + ('...' if template|length > 60 else '') }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editConfig('{{ webhook_type }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('{{ webhook_type }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Wizard -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Create New Configuration</h5>
                    </div>
                    <div class="card-body">
                        <!-- Step 1: JSON Payload Input -->
                        <div id="step1" class="configuration-step">
                            <h6 class="text-primary mb-3"><i class="fas fa-file-code me-2"></i>Step 1: Provide Sample Payload</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="webhookType" class="form-label">Webhook Type Name</label>
                                        <input type="text" class="form-control" id="webhookType" placeholder="e.g., github, stripe, slack">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Quick Templates</label>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('github')">GitHub</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('stripe')">Stripe</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('slack')">Slack</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">Load Recent Payload</label>
                                        <div class="d-flex align-items-center gap-2">
                                            <select class="form-select" id="webhookTypeSelect" style="max-width: 200px;">
                                                <option value="">Select webhook type...</option>
                                            </select>
                                            <select class="form-select" id="recentPayloadSelect" style="max-width: 300px;" disabled>
                                                <option value="">Select a recent payload...</option>
                                            </select>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="loadRecentPayload()" disabled id="loadRecentBtn">
                                                <i class="fas fa-download me-1"></i>Load Payload
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">Load a real payload from webhook logs for testing and template building</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="jsonPayload" class="form-label">JSON Payload</label>
                                <textarea class="form-control font-monospace" id="jsonPayload" rows="10" 
                                          placeholder="Paste your JSON webhook payload here..."></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary" onclick="validateJson()">
                                    <i class="fas fa-check-circle me-1"></i>Validate JSON
                                </button>
                                <button type="button" class="btn btn-primary" onclick="analyzePayload()" disabled id="analyzeBtn">
                                    <i class="fas fa-search me-1"></i>Analyze Payload
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Field Selection -->
                        <div id="step2" class="configuration-step d-none">
                            <h6 class="text-primary mb-3"><i class="fas fa-tasks me-2"></i>Step 2: Select Fields</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Available Fields</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="fieldsTree">
                                            <!-- Fields will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Selected Fields</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="selectedFields">
                                                <p class="text-muted"><i>No fields selected</i></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" onclick="showStep(1)">
                                    <i class="fas fa-arrow-left me-1"></i>Back
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showStep(3)" disabled id="nextToTemplateBtn">
                                    <i class="fas fa-arrow-right me-1"></i>Create Template
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Template Building -->
                        <div id="step3" class="configuration-step d-none">
                            <h6 class="text-primary mb-3"><i class="fas fa-edit me-2"></i>Step 3: Build Message Template</h6>
                            
                            <div class="mb-3">
                                <label for="messageTemplate" class="form-label">Message Template</label>
                                <textarea class="form-control" id="messageTemplate" rows="3" 
                                          placeholder="Create your message template using field variables..."></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Available Variables</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 200px; overflow-y: auto;" id="availableVariables">
                                            <!-- Variables will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Live Preview</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="messagePreview" class="border rounded p-2 bg-light">
                                                <em class="text-muted">Preview will appear here...</em>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Payload Loading for Edit Mode -->
                            <div id="editModeRecentPayload" class="d-none mb-3 mt-3">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-download me-2"></i>Load Recent Payload (Edit Mode)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center gap-2">
                                            <select class="form-select" id="editWebhookTypeSelect" style="max-width: 200px;">
                                                <option value="">Select webhook type...</option>
                                            </select>
                                            <select class="form-select" id="editRecentPayloadSelect" style="max-width: 300px;" disabled>
                                                <option value="">Select a recent payload...</option>
                                            </select>
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="loadRecentPayloadToEdit()" disabled id="editLoadRecentBtn">
                                                <i class="fas fa-download me-1"></i>Load
                                            </button>
                                        </div>
                                        <small class="form-text text-muted mt-2">Load a real payload from webhook logs to test your configuration changes</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Payload for Edit Mode -->
                            <div id="editModeTestPayload" class="d-none mb-3 mt-3">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-vial me-2"></i>Test Payload (Edit Mode)</h6>
                                    </div>
                                    <div class="card-body">
                                        <textarea class="form-control font-monospace" id="editTestPayload" rows="4" 
                                                  placeholder="Paste a sample JSON payload here to test your configuration..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" onclick="showStep(2)">
                                    <i class="fas fa-arrow-left me-1"></i>Back
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-info me-2" onclick="toggleEditTestPayload()" id="toggleTestPayloadBtn" style="display: none;">
                                        <i class="fas fa-vial me-1"></i>Add Test Payload
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="testConfiguration()">
                                        <i class="fas fa-play me-1"></i>Test Config
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="saveConfiguration()" disabled id="saveConfigBtn">
                                        <i class="fas fa-save me-1"></i>Save Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast for notifications -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
            <div id="notificationToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notification</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-3 mt-5">
        <div class="container text-center text-muted">
            <small>GenHook v1.0 - Configuration-driven Webhook Processing</small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global state
        let currentStep = 1;
        let analyzedPayload = null;
        let selectedFieldsList = [];
        let currentWebhookType = '';
        let webConfig = {}; // Web interface configuration

        // Load configurations and web config on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadWebConfig();
            loadConfigurations();
        });

        async function loadWebConfig() {
            try {
                const response = await fetch('/api/web-config');
                if (response.ok) {
                    webConfig = await response.json();
                } else {
                    console.warn('Failed to load web config, using defaults');
                }
            } catch (error) {
                console.warn('Error loading web config:', error);
            }
        }

        function showNotification(title, message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            toastHeader.className = 'toast-header';
            if (type === 'success') {
                toastHeader.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastHeader.classList.add('bg-danger', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function showStep(step) {
            document.querySelectorAll('.configuration-step').forEach(s => s.classList.add('d-none'));
            document.getElementById(`step${step}`).classList.remove('d-none');
            currentStep = step;
            
            if (step === 3) {
                updateAvailableVariables();
            }
        }

        function validateJson() {
            const payload = document.getElementById('jsonPayload').value.trim();
            if (!payload) {
                showNotification('Error', 'Please enter a JSON payload', 'error');
                return false;
            }
            
            try {
                JSON.parse(payload);
                showNotification('Success', 'JSON is valid', 'success');
                document.getElementById('analyzeBtn').disabled = false;
                return true;
            } catch (e) {
                showNotification('Error', `Invalid JSON: ${e.message}`, 'error');
                return false;
            }
        }

        function loadSample(type) {
            const samples = {
                github: {
                    type: 'github',
                    payload: `{
  "action": "opened",
  "pull_request": {
    "title": "Add new feature",
    "user": {"login": "developer"}
  },
  "repository": {"name": "my-repo"}
}`
                },
                stripe: {
                    type: 'stripe', 
                    payload: `{
  "type": "payment_intent.succeeded",
  "data": {
    "object": {
      "amount": 2000,
      "currency": "usd",
      "status": "succeeded"
    }
  }
}`
                },
                slack: {
                    type: 'slack',
                    payload: `{
  "event": {
    "type": "message",
    "user": "U1234567",
    "text": "Hello world"
  }
}`
                }
            };
            
            const sample = samples[type];
            if (sample) {
                document.getElementById('webhookType').value = sample.type;
                document.getElementById('jsonPayload').value = sample.payload;
                validateJson();
            }
        }

        async function analyzePayload() {
            const webhookType = document.getElementById('webhookType').value.trim();
            const payload = document.getElementById('jsonPayload').value.trim();
            
            if (!webhookType || !validateJson()) return;
            
            try {
                const response = await fetch('/api/analyze-payload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        payload: JSON.parse(payload),
                        webhook_type: webhookType
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    analyzedPayload = result;
                    analyzedPayload.original_payload = JSON.parse(payload);
                    currentWebhookType = webhookType;
                    displayFields(result.fields);
                    showStep(2);
                    showNotification('Success', `Found ${result.total_fields} fields`, 'success');
                } else {
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to analyze payload', 'error');
            }
        }

        function displayFields(fields) {
            const container = document.getElementById('fieldsTree');
            container.innerHTML = '';
            
            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${field.pattern}" 
                           id="field_${field.path.replace(/\./g, '_')}" onchange="updateSelectedFields()">
                    <label class="form-check-label" for="field_${field.path.replace(/\./g, '_')}">
                        <code class="text-primary">${field.pattern}</code>
                        <small class="text-muted d-block">${field.field_type}</small>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function updateSelectedFields() {
            selectedFieldsList = [];
            const checkboxes = document.querySelectorAll('#fieldsTree input:checked');
            
            checkboxes.forEach(cb => selectedFieldsList.push(cb.value));
            
            const container = document.getElementById('selectedFields');
            if (selectedFieldsList.length === 0) {
                container.innerHTML = '<p class="text-muted"><i>No fields selected</i></p>';
            } else {
                container.innerHTML = selectedFieldsList.map(field => 
                    `<span class="badge bg-primary me-1 mb-1">${field}</span>`
                ).join('');
            }
            
            document.getElementById('nextToTemplateBtn').disabled = selectedFieldsList.length === 0;
        }

        function updateAvailableVariables() {
            const container = document.getElementById('availableVariables');
            if (selectedFieldsList.length === 0) {
                container.innerHTML = '<p class="text-muted"><i>No fields selected</i></p>';
                return;
            }
            
            const variables = selectedFieldsList.map(pattern => 
                pattern.replace(/\{([^}]+)\}/g, '.$1')
            );
            
            container.innerHTML = variables.map(variable => 
                `<div class="mb-1">
                    <code class="text-success cursor-pointer" onclick="insertVariable('${variable}')" 
                          style="cursor: pointer;">$${variable}$</code>
                </div>`
            ).join('');
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('messageTemplate');
            const pos = textarea.selectionStart;
            const text = textarea.value;
            textarea.value = text.substring(0, pos) + `$${variable}$` + text.substring(pos);
            textarea.focus();
            updatePreview();
        }

        function updatePreview() {
            const template = document.getElementById('messageTemplate').value;
            document.getElementById('messagePreview').textContent = template || 'Preview will appear here...';
            document.getElementById('saveConfigBtn').disabled = !template.trim();
        }

        function toggleEditTestPayload() {
            const payloadDiv = document.getElementById('editModeTestPayload');
            const toggleBtn = document.getElementById('toggleTestPayloadBtn');
            
            if (payloadDiv.classList.contains('d-none')) {
                payloadDiv.classList.remove('d-none');
                toggleBtn.innerHTML = '<i class="fas fa-times me-1"></i>Hide Test Payload';
            } else {
                payloadDiv.classList.add('d-none');
                toggleBtn.innerHTML = '<i class="fas fa-vial me-1"></i>Add Test Payload';
            }
        }

        async function testConfiguration() {
            const template = document.getElementById('messageTemplate').value.trim();
            if (!template) {
                showNotification('Error', 'Please enter a message template', 'error');
                return;
            }
            
            let testPayload = null;
            
            // First, check if user provided a manual test payload (edit mode)
            const editPayload = document.getElementById('editTestPayload').value.trim();
            if (editPayload) {
                try {
                    testPayload = JSON.parse(editPayload);
                } catch (e) {
                    showNotification('Error', 'Invalid JSON in test payload', 'error');
                    return;
                }
            } 
            // Otherwise, use the original analyzed payload (if it has real data)
            else if (analyzedPayload && analyzedPayload.original_payload && Object.keys(analyzedPayload.original_payload).length > 0) {
                testPayload = analyzedPayload.original_payload;
            } 
            // No payload available
            else {
                showNotification('Error', 'No test payload available. Please paste JSON in the test payload field.', 'error');
                return;
            }
            
            try {
                const requestData = {
                    webhook_type: currentWebhookType,
                    test_payload: testPayload,
                    selected_fields: selectedFieldsList,
                    message_template: template
                };
                
                const response = await fetch('/api/test-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                const previewDiv = document.getElementById('messagePreview');
                
                if (result.success) {
                    previewDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✅ Test Successful!</strong><br>
                            <strong>Generated Message:</strong><br>
                            <code>${result.generated_message}</code><br><br>
                            <strong>Processing Time:</strong> ${result.processing_time_ms}ms
                        </div>
                    `;
                    showNotification('Success', 'Configuration works!', 'success');
                } else {
                    previewDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>❌ Test Failed:</strong><br>
                            ${result.error_message || 'Unknown error'}
                        </div>
                    `;
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to test configuration', 'error');
            }
        }

        async function saveConfiguration() {
            const template = document.getElementById('messageTemplate').value.trim();
            if (!template) {
                showNotification('Error', 'Please enter a message template', 'error');
                return;
            }
            
            try {
                const configLine = selectedFieldsList.join(',') + '::' + template;
                
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        webhook_type: currentWebhookType,
                        config_line: configLine,
                        create_backup: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Success', `Webhook '${currentWebhookType}' saved successfully`, 'success');
                    
                    // Force complete reset and refresh
                    resetWizard();
                    loadConfigurations();
                    
                    // Additional cleanup - force DOM refresh
                    setTimeout(() => {
                        resetWizard();
                    }, 100);
                } else {
                    showNotification('Error', result.error_message, 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to save configuration', 'error');
            }
        }

        function resetWizard() {
            // Clear all global state
            analyzedPayload = null;
            selectedFieldsList = [];
            currentWebhookType = '';
            
            // Clear all form fields
            document.getElementById('webhookType').value = '';
            document.getElementById('jsonPayload').value = '';
            document.getElementById('messageTemplate').value = '';
            document.getElementById('editTestPayload').value = '';
            
            // Clear all dynamic content areas
            document.getElementById('fieldsTree').innerHTML = '';
            document.getElementById('selectedFields').innerHTML = '<p class="text-muted"><i>No fields selected</i></p>';
            document.getElementById('availableVariables').innerHTML = '';
            document.getElementById('messagePreview').innerHTML = '<em class="text-muted">Preview will appear here...</em>';
            
            // Reset all button states
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('nextToTemplateBtn').disabled = true;
            document.getElementById('saveConfigBtn').disabled = true;
            document.getElementById('toggleTestPayloadBtn').style.display = 'none';
            document.getElementById('editModeTestPayload').classList.add('d-none');
            
            // Clear any selected checkboxes in fields tree
            const checkboxes = document.querySelectorAll('#fieldsTree input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            // Reset to step 1
            showStep(1);
        }

        async function loadConfigurations() {
            try {
                const response = await fetch('/api/configs');
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.getElementById('configurationsTable');
                    tbody.innerHTML = '';
                    
                    Object.entries(result.configurations).forEach(([webhookType, configLine]) => {
                        const [fields, template] = configLine.split('::', 2);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><code>${webhookType}</code></td>
                            <td class="small text-muted">${fields.length > 50 ? fields.substring(0, 50) + '...' : fields}</td>
                            <td class="small">${template.length > 60 ? template.substring(0, 60) + '...' : template}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editConfig('${webhookType}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${webhookType}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('configCount').textContent = `${result.total_count} Configured`;
                }
            } catch (error) {
                console.error('Failed to load configurations:', error);
            }
        }

        async function editConfig(webhookType) {
            try {
                const response = await fetch(`/api/config/${webhookType}`);
                const result = await response.json();
                
                if (response.ok) {
                    resetWizard();
                    
                    document.getElementById('webhookType').value = webhookType;
                    currentWebhookType = webhookType;
                    document.getElementById('messageTemplate').value = result.message_template;
                    selectedFieldsList = result.fields;
                    
                    const mockFields = result.fields.map(field => ({
                        pattern: field,
                        path: field.replace(/\{/g, '.').replace(/\}/g, ''),
                        field_type: 'string'
                    }));
                    
                    analyzedPayload = {
                        success: true,
                        fields: mockFields,
                        original_payload: {}
                    };
                    
                    displayFields(mockFields);
                    selectedFieldsList.forEach(field => {
                        const checkbox = document.querySelector(`input[value="${field}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    updateSelectedFields();
                    
                    showStep(3);
                    updateAvailableVariables();
                    updatePreview();
                    
                    const toggleBtn = document.getElementById('toggleTestPayloadBtn');
                    if (toggleBtn) {
                        toggleBtn.style.display = 'inline-block';
                    }
                    
                    // Show recent payload section and auto-populate webhook type
                    const editModeRecentPayload = document.getElementById('editModeRecentPayload');
                    const editWebhookTypeSelect = document.getElementById('editWebhookTypeSelect');
                    if (editModeRecentPayload) {
                        editModeRecentPayload.classList.remove('d-none');
                    }
                    if (editWebhookTypeSelect) {
                        editWebhookTypeSelect.value = webhookType;
                        // Trigger change event to load recent payloads
                        const event = new Event('change');
                        editWebhookTypeSelect.dispatchEvent(event);
                    }
                    
                    showNotification('Edit Mode', `Editing configuration for '${webhookType}' - Use "Load Recent Payload" to test with real data`, 'info');
                } else {
                    showNotification('Error', 'Failed to load configuration', 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to load configuration', 'error');
            }
        }

        async function deleteConfig(webhookType) {
            if (!confirm(`Delete configuration for '${webhookType}'?`)) return;
            
            try {
                const response = await fetch(`/api/config/${webhookType}`, {method: 'DELETE'});
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Success', `Webhook '${webhookType}' deleted`, 'success');
                    loadConfigurations();
                } else {
                    showNotification('Error', result.detail || 'Delete failed', 'error');
                }
            } catch (error) {
                showNotification('Error', 'Failed to delete configuration', 'error');
            }
        }

        // Auto-update preview
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageTemplate').addEventListener('input', updatePreview);
        });
    </script>
</body>
</html>